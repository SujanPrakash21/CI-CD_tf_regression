name: CI_CD_tf_regression

on:
  push:
    branches: [ main, pipeline]
  pull_request:
    branches: [main]

jobs:
  ci:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: |
        pip install -r requirements.txt

    - name: Train Model and Generate Artifacts
      run: |
        echo "Starting model training..."
        python model.py
        
        echo "=== Checking generated files ==="
        ls -la
        
        # Verify critical files exist
        if [ -f model.h5 ]; then
          echo "âœ… model.h5 created successfully"
        else
          echo "âŒ model.h5 missing!"
          exit 1
        fi
        
        if [ -f model_results.png ]; then
          echo "âœ… model_results.png created successfully"
        else
          echo "âŒ model_results.png missing!"
          exit 1
        fi
        
        if [ -f metrics.txt ]; then
          echo "âœ… metrics.txt created successfully"
          echo "Metrics content:"
          cat metrics.txt
        else
          echo "âŒ metrics.txt missing!"
          exit 1
        fi

    - name: Create Training Report
      run: |
        echo "# ðŸš€ Model Training Report" > report.md
        echo "" >> report.md
        echo "## ðŸ“Š Training Summary" >> report.md
        echo "- **Branch:** \`${{ github.ref }}\`" >> report.md
        echo "- **Commit:** \`${{ github.sha }}\`" >> report.md
        echo "- **Workflow:** \`${{ github.workflow }}\`" >> report.md
        echo "" >> report.md
        
        echo "## ðŸ“ˆ Model Metrics" >> report.md
        if [ -f metrics.txt ]; then
          cat metrics.txt >> report.md
        else
          echo "Training completed - check artifacts for details" >> report.md
        fi
        
        echo "" >> report.md
        echo "## ðŸŽ¯ Generated Artifacts" >> report.md
        echo "The following files were generated during training:" >> report.md
        [ -f model.h5 ] && echo "- âœ… **Model Weights**: \`model.h5\`" >> report.md
        [ -f model_results.png ] && echo "- âœ… **Training Plot**: \`model_results.png\`" >> report.md
        [ -f metrics.txt ] && echo "- âœ… **Metrics**: \`metrics.txt\`" >> report.md
        
        echo "" >> report.md
        echo "---" >> report.md
        echo "*Automated training report generated by GitHub Actions*" >> report.md

    - name: Upload Model Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: model-artifacts
        path: |
          model.h5
          model_results.png
          metrics.txt
          report.md
        retention-days: 7

    - name: Display Training Summary
      run: |
        echo "=== TRAINING COMPLETED SUCCESSFULLY ==="
        echo "Generated artifacts:"
        echo "  - model.h5 (TensorFlow model)"
        echo "  - model_results.png (Training visualization)" 
        echo "  - metrics.txt (Performance metrics)"
        echo "  - report.md (Training summary)"
